name: MLOps Pipeline - Train & Deploy

# Trigger conditions
on:
  push:
    branches:
      - main
      - develop
  # schedule:
  #   # Run training daily at 2 AM UTC (automated retraining)
  #   # DISABLED - uncomment when ready for automated training
  #   - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  test-and-train:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out your code
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # Step 2: Set up Python environment
      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # Step 3: Install dependencies
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest
      
      # Step 4: Setup GCP credentials
      - name: Setup Google Cloud Credentials
        run: |
          mkdir -p config
          cat > config/service-account-key.json << 'EOF'
          ${{ secrets.GCP_SA_KEY }}
          EOF
      
      # Step 5: Run training pipeline
      - name: Train Models
        run: |
          python train_pipeline.py
      
      # Step 6: Upload artifacts for inspection
      - name: Upload Training Artifacts
        if: always()  # Upload even if previous steps fail
        uses: actions/upload-artifact@v4
        with:
          name: training-artifacts
          path: |
            artifacts/
            logs/
          retention-days: 30
      
      # Step 7: Run inference test (skip for now - model pusher will validate)
      # - name: Test Model & Preprocessor
      #   if: success()
      #   run: |
      #     python test_inference.py
      
      # Step 8: Notify on success
      - name: Notify Success
        if: success()
        run: |
          echo "✓ Pipeline completed successfully!"
          echo "Model pushed to GCS and registered in Vertex AI"
      
      # Step 9: Notify on failure
      - name: Notify Failure
        if: failure()
        run: |
          echo "✗ Pipeline failed. Check logs above."
          exit 1

  # Optional: Deploy to Vertex AI Endpoint
  deploy:
    runs-on: ubuntu-latest
    needs: test-and-train  # Only run if training succeeded
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Deploy Model to Vertex AI Endpoint
        run: |
          # This creates a managed endpoint that serves predictions
          echo "Deploying model to Vertex AI..."
          echo "Model already pushed to GCS and registered in Vertex AI by training job"
          echo "Deployment placeholder - can run deploy_to_vertex_ai.py here if needed"
